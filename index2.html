<html>
	<head>
		<title>number two</title>
		<style>
			body {
				font-family:arial;
			}
			ul {
				list-style-type:none;
				padding-left:0px;
			}

			li {
				padding:0px;
				position:relative;
			}

			h3 {
				padding:0px 0px 0px 5px;
				margin:0px;
			}

			#top {
				padding:0px;
			}
			#top>.list {
				display:inline-block;
				vertical-align:top;
				width:200px;
				margin:2px;
				padding:0px;
			}

			.list {
				border:solid;
				border-width:5px;
				margin:1px;
			}

			.list>h3{
				background-color:black;
				color:white;
				padding:0px;
			}
			.list>.toolbar{
				color:white;
			}

			.list.selected {
				border-color:#555555;
			}
			.list.selected>h3 {
			}

			.selected>h3,.selected>.toolbar {
				background-color:#555555;
				color:white;
			}

			.toolbar{
				color:black;
				font-weight:700;

				position:absolute;
				right:5px;
				top:0;
			}
		</style>

		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
		<script>
			var id_counter;

			function init() {
				var list;

				id_counter = 0;

				list = loadList();
				if(list) {
					parseList( loadList() );
				}
				$("#top").click( topClickHandler );
			}

			function addList( listName, destination ) {
				var newList,		// The list we'll be creating
					newItem;		// The item that the list will reside in

				newList = $( document.createElement("ul") );

				// Let addItem take care of the list node
				newItem = addItem( listName, destination, true );
				newItem = $( newItem );
				newItem.addClass("list");

				// Add the new list to the new list node
				newItem.append( newList );

				// Update localStorage
				saveList( scanList() );

				// Return the list element and remove the jQuery stuff.
				return newList[ 0 ];
			}

			function addItem( itemName, destination, skipUpdate ) {
				var newItem,		// The new list node to be appended to destination
					itemHeader,		// The header node contained in the list
					destinationTag,
					toolbar;

				// Create and attach a h3 to a new list node
				itemHeader = $( document.createElement("h3") );
				itemHeader.html( itemName );

				newItem = $( document.createElement("li") );
				newItem.append( itemHeader );
				newItem.click( liClickHandler );

				// Get proper destination.  If it's not a list, insert after given dest.
				destinationTag = $( destination ).prop("tagName");
				if( destinationTag === "UL" ) {
					$( destination ).prepend( newItem );
				} else if( $(destination).children("ul").length ) {
					$( destination ).children("ul").prepend( newItem );
				} else if( $( destination ).children.length ) {
					newItem.insertAfter( destination );
				} else {
					return 0;
				}

				// Attach toolbar
				setTimeout( function() {
					toolbar = makeToolbar( newItem[0] );
					newItem.append( toolbar );
				}, 0);

				// Update localStorage
				if( !skipUpdate ) {
					saveList( scanList() );
				}

				// Return the list node without jQuery stuff
				return newItem[ 0 ];
			}

			function deleteItem( itemDOMNode ) {
				var oldNode;

				// Pull the node out of the DOM, and return it to the user.
				oldNode = $( itemDOMNode ).detach();

				// Update localStorage
				saveList( scanList() );

				return oldNode[ 0 ];
			}

			function scanList() {
				var parsedDOM,
					scanStack,
					domStack,
					curScan,
					curDOM,
					nextDOM,
					curChild,
					childTag,
					i;

				parsedDOM = {
					"lists" : []
				};

				scanStack = [];
				scanStack.push( parsedDOM.lists );

				domStack = [];
				domStack.push( $("#top") );

				while( domStack.length ) {
					curDOM = domStack.pop();
					curScan = scanStack.pop();

					for( i=0; i<curDOM.children().length; i++ ) {
						curChild = curDOM.children()[ i ];
						childTag = $( curChild ).prop( "tagName" );

						if( childTag === "LI" ) {
							curScan[ i ] = {};
							curScan[ i ].header = $( curChild ).children("h3").html();

							nextDOM = $( curChild ).children("ul");
							if( nextDOM[0] ) {
								curScan[ i ].list = [];

								domStack.push( nextDOM );
								scanStack.push( curScan[i].list );
							} else {
								curScan[ i ].list = null;
							}

						}
					}
				}

				return parsedDOM;
			}

			function makeToolbar(item) {
				var close,
					min,
					add,
					toolbar;

				toolbar = $( document.createElement("span") );
				toolbar.addClass("toolbar");

				close = $( document.createElement("span") );
				close.html("X");
				close.click( closeClickHandler );
				toolbar.prepend( close );

				if( $(item).hasClass("list") ) {
					min = $( document.createElement("span") );
					min.html("_");
					min.click( minClickHandler );
					toolbar.prepend( min );
				}

				add = $( document.createElement("span") );
				add.html("+");
				add.click( addClickHandler );
				toolbar.prepend( add );

				return toolbar[ 0 ];
			}

			function parseList(list) {
				var domFinal,
					scanStack,
					domStack,
					curScan,
					curDOM,
					nextDOM,
					nextChild,
					curHeading,
					i;

				domFinal = $( document.createElement("ul") );

				scanStack = [];
				scanStack.push( list.lists );

				domStack = [];
				domStack.push( $("#top") );

				while( scanStack.length ) {
					curDOM = domStack.pop();
					curScan = scanStack.pop();

					for( i=curScan.length-1; i>=0; i-- ) {
						if( curScan[i].list ) {
							nextDOM = addList( curScan[i].header, curDOM );

							domStack.push( nextDOM );
							scanStack.push( curScan[i].list );
						} else {
							addItem( curScan[i].header, curDOM );
						}
					}
				}
			}

			function parseList_old(list) {
				var domFinal,
					scanStack,
					domStack,
					curScan,
					curDOM,
					curChild,
					nextChild,
					curHeading,
					i;

				domFinal = $( document.createElement("ul") );

				scanStack = [];
				scanStack.push( list.lists );

				domStack = [];
				domStack.push( domFinal );

				while( scanStack.length ) {
					curDOM = domStack.pop();
					curScan = scanStack.pop();

					for( i=0; i<curScan.length; i++ ) {
						curChild = $( document.createElement("li") );

						curHeading = $( document.createElement("h3") );
						curHeading.html( curScan[i].header );

						curChild.append( curHeading );

						curDOM.append( curChild );

						if( curScan[i].list ) {
							nextChild = $( document.createElement("ul") );
							curChild.append( nextChild );
							domStack.push( nextChild );
							scanStack.push( curScan[i].list );
						}
					}
				}

				$("#top").replaceWith( domFinal );
			}

			function saveList(list) {
				localStorage.list = JSON.stringify( list );
			}

			function loadList() {
				if( localStorage.list ) {
					return JSON.parse( localStorage.list );
				}

				return 0;
			}


			function liClickHandler(e) {
				var selected;

				selected = $( e.currentTarget );
				$(".selected").removeClass("selected");
				selected.addClass("selected");

				e.stopPropagation();
			}

			function topClickHandler(e){
				$(".selected").removeClass("selected");
			}

			function closeClickHandler(e) {
				var itemDOMNode;

				itemDOMNode = $( e.currentTarget ).parent().parent()[ 0 ];
				deleteItem( itemDOMNode );
			}

			function addClickHandler(e) {
				var itemDOMNode,
					text;

				itemDOMNode = $( e.currentTarget ).parent().parent()[ 0 ];

				text = $("#myTextbox").val();

				addItem( text, itemDOMNode );
			}

			function minClickHandler(e) {
				var itemDOMNode;

				itemDOMNode = $( e.currentTarget ).parent().parent().children("ul");
				itemDOMNode.toggle();
			}

			function addListButtonHandler(e) {
				var title,
					destination,
					selected;

				title = $("#myTextbox").val();
				selected = $(".selected");

				if( selected.length ) {
					destination = $(".selected")[ 0 ];
				} else {
					destination = $("#top")[ 0 ]
				}

				addList( title, destination );
			}

			function addItemButtonHandler(e) {
				var title,
					destination;

				title = $("#myTextbox").val();

				destination = $(".selected")[0];

				addItem( title, destination );
			}

			function deleteItemHeaderHandler(e) {
				var itemDOMNode;

				itemDOMNode = $( e.target ).parent()[ 0 ];
				deleteItem( itemDOMNode );
			}
		</script>
	</head>
	<body>
		<div id="testing">
			<button id="itemAdd">add item</button>
			<button id="listAdd">add list</button>
			<form action="javascript:addItemButtonHandler()">
				<input type="text" id="myTextbox" />
			</form>
		</div>
		<ul id="top"></ul>

		<script>
			$(document).ready( function() {
				init();
				$("#itemAdd").click(addItemButtonHandler);
				$("#listAdd").click(addListButtonHandler);
			});
		</script>
	</body>
</html>
